<%@ page import="java.util.Date" %>
<%@ page import="Tables.Termin" %>
<%@ page import="Tables.Rechnung" %>
<%@ page import="java.util.List" %>
<%@ page import="java.text.SimpleDateFormat" %>
<%@ page import="Views.FahrzeugeMitTermindaten" %>
<%@ page import="Tables.Fahrzeug" %>
<%@ page import="DataAccessObjects.*" %>
<%@ page import="java.util.ArrayList" %>
<%@ page import="Tables.Fahrzeugmodell" %>
<%--
  Created by IntelliJ IDEA.
  User: Marco
  Date: 22.07.2015
  Time: 00:29
  To change this template use File | Settings | File Templates.
--%>
<jsp:useBean id="loggedKunde" class="Tables.Kunde" scope="session"/>
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<html>
<head>
  <title>Erstelle Termin Fahrzeugauswahl</title>
  <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="bootstrap/css/bootstrap-theme.min.css" rel="stylesheet">
</head>

<body>
<%

  String start = request.getParameter("startDate"),
          end = request.getParameter("endDate");
  ArrayList<Integer> nichtVerfFahrzeuge = new ArrayList<Integer>();
  FahrzeugmodellDAO fMDAO = new FahrzeugmodellDAO();
  List<Fahrzeugmodell> allModelle = fMDAO.readAllFahrzeugmodelle();
  int kundenNummer = loggedKunde.getId();
  int fahrzeugNummer = 0, laufleistung = 0, anzahl_sitzplaetze = 0, i, k, j = 0;
  String nummernschild = null, hersteller = null, fahrzeugtyp = null;
  FahrzeugDAO fDAO = new FahrzeugDAO();
  List<Fahrzeug> allFahrzeuge = fDAO.readAllFahrzeuge();
  ViewDAO viewDAO = new ViewDAO();
  List<FahrzeugeMitTermindaten> verfFahrzeuge = viewDAO.getFahrzeugeMitTermindaten(start,end);

%>
<%!

  public boolean checkDate(String d1, String d2){
    SimpleDateFormat format = new SimpleDateFormat("YYYY-MM-DD");
    Date date1 = null, date2 = null;
    try {
      date1 = format.parse(d1);
      date2 = format.parse(d2);
    } catch (Exception e) {
      e.printStackTrace();
    }
    if (date1.after(date2)) {
      return false;
    }
    return true;
  }

  public void createNewTermin(Date start, Date end, int kundennummer, int fahrzeugnummer){
    TerminDAO tDAO = new TerminDAO();
    tDAO.addTermin(start, end, kundennummer);
    RechnungDAO rDAO = new RechnungDAO();
    int diffInDays = (int)( (end.getTime() - start.getTime())
            / (1000 * 60 * 60 * 24));
    rDAO.addRechnung(diffInDays*100,kundennummer,start,end);
    TerminManagementDAO tMDAO = new TerminManagementDAO();
    List<Termin> terminList = tDAO.readAllTermine();
    List<Rechnung> rechnungList = rDAO.getAll();
    int rechnungsnummer = rechnungList.get(rechnungList.size()-1).getRechnungsNummer();
    int terminnumer = terminList.get(terminList.size()-1).getTerminnummer();
    tMDAO.addTerminManagement(rechnungsnummer,fahrzeugnummer,terminnumer);
  }

%>

<div class="container">
  <table class="table table-bordered">
    <thead>
    <tr>
      <th>Fahrzeugnummer</th>
      <th>Laufleistung</th>
      <th>Nummernschild</th>
      <th>Hersteller</th>
      <th>Fahrzeugtyp</th>
      <th>Sitzplaetze</th>
    </tr>
    </thead>
    <%
      //Holt sich die Fahrzeuge aus der View mit den Termindaten, die nicht verfügbar sind und zeigt dann alle
      //übrigen Fahrzeuge an, die nicht in der Liste sind.
      for (k = 0; k < verfFahrzeuge.size();k++) {
        nichtVerfFahrzeuge.add(verfFahrzeuge.get(k).getFahrzeugnummer());
      }
      for(i=0; i< allFahrzeuge.size(); i++){
        boolean fahrzeugVerf = true;
        for (int m = 0; m < nichtVerfFahrzeuge.size(); m++) {
          if(allFahrzeuge.get(i).getFahrzeugNummer() == (int) nichtVerfFahrzeuge.get(m)) {
            fahrzeugVerf = false;
          }
        }
        if (fahrzeugVerf) {
          fahrzeugNummer = allFahrzeuge.get(i).getFahrzeugNummer();
          laufleistung = allFahrzeuge.get(i).getLaufleistung();
          nummernschild = allFahrzeuge.get(i).getNummernschild();
          for (j = 0; j < allModelle.size(); j++) {
            if (allFahrzeuge.get(i).getFModellNummer() == allModelle.get(j).getModellnummer()) {
              hersteller = allModelle.get(j).getHersteller();
              fahrzeugtyp = allModelle.get(j).getFahrzeugTyp();
              anzahl_sitzplaetze = allModelle.get(j).getAnzahlSitzplaetze();
            }
          }
          %>
    <tbody>
    <tr>
      <td><%= fahrzeugNummer%></td>
      <td><%= laufleistung%></td>
      <td><%= nummernschild%></td>
      <td><%= hersteller%></td>
      <td><%= fahrzeugtyp%></td>
      <td><%= anzahl_sitzplaetze%></td>
    </tr>
    </tbody>
    <%
        }
      }%>
  </table>
</div>


<%
  if (request.getParameter("startDate") != null) {
    if(checkDate(start, end)){
    }else {
      %>
      <script>
              alert("Das Enddatum kann nicht vor dem Startdatum liegen!");
              window.location.href= "createTermin.jsp";
      </script>
<%
      }
    }

  //if (request.getParameter() != null) {
   // fahrzeugNummer = request.getParameter("");
  //}
%>

</body>
</html>
